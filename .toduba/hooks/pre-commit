#!/bin/bash

# Toduba Pre-commit Hook
# Automatically runs checks before allowing commits

set -e

echo "ðŸ” Toduba Pre-commit Checks Starting..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Progress tracking
TOTAL_CHECKS=5
CURRENT=0

show_progress() {
    CURRENT=$((CURRENT + 1))
    PERCENT=$((CURRENT * 100 / TOTAL_CHECKS))
    printf "[%3d%%] %s\n" "$PERCENT" "$1"
}

# Check 1: Linting
show_progress "Running linter..."
if [ -f "package.json" ]; then
    if grep -q '"lint"' package.json; then
        npm run lint --silent || {
            echo -e "${RED}âŒ Linting failed${NC}"
            echo "Fix with: npm run lint:fix"
            exit 1
        }
        echo -e "${GREEN}âœ“ Linting passed${NC}"
    fi
elif [ -f "pubspec.yaml" ]; then
    flutter analyze || {
        echo -e "${RED}âŒ Flutter analyze failed${NC}"
        exit 1
    }
fi

# Check 2: Formatting
show_progress "Checking code formatting..."
if [ -f "package.json" ]; then
    if grep -q '"prettier"' package.json; then
        npx prettier --check . || {
            echo -e "${YELLOW}âš ï¸ Code formatting issues found${NC}"
            echo "Fix with: npx prettier --write ."
            read -p "Auto-fix formatting? (y/n): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                npx prettier --write .
                git add -A
            else
                exit 1
            fi
        }
    fi
fi

# Check 3: Type checking
show_progress "Type checking..."
if [ -f "tsconfig.json" ]; then
    npx tsc --noEmit || {
        echo -e "${RED}âŒ TypeScript errors found${NC}"
        exit 1
    }
    echo -e "${GREEN}âœ“ Type checking passed${NC}"
fi

# Check 4: Test affected files
show_progress "Running tests for changed files..."
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|tsx|jsx)$' || true)

if [ -n "$CHANGED_FILES" ]; then
    if [ -f "package.json" ] && grep -q '"test"' package.json; then
        # Run tests for changed files
        npm test -- --findRelatedTests $CHANGED_FILES --passWithNoTests || {
            echo -e "${RED}âŒ Tests failed${NC}"
            exit 1
        }
        echo -e "${GREEN}âœ“ Tests passed${NC}"
    fi
fi

# Check 5: Security checks
show_progress "Security scan..."

# Check for hardcoded secrets
SECRET_PATTERNS=(
    "api[_-]?key"
    "secret[_-]?key"
    "password"
    "token"
    "AWS_"
    "GITHUB_"
)

for pattern in "${SECRET_PATTERNS[@]}"; do
    FOUND=$(git diff --cached --name-only -z | xargs -0 grep -l "$pattern.*=.*['\"]" || true)
    if [ -n "$FOUND" ]; then
        echo -e "${YELLOW}âš ï¸ Warning: Possible secret in:${NC}"
        echo "$FOUND"
        read -p "Continue anyway? (y/n): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
done

# Check for console.log in production code
if [ -f "package.json" ]; then
    CONSOLE_LOGS=$(git diff --cached --name-only | xargs grep -l "console.log" | grep -v test || true)
    if [ -n "$CONSOLE_LOGS" ]; then
        echo -e "${YELLOW}âš ï¸ console.log found in:${NC}"
        echo "$CONSOLE_LOGS"
        read -p "Remove console.logs? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            for file in $CONSOLE_LOGS; do
                sed -i '' '/console.log/d' "$file"
                git add "$file"
            done
        fi
    fi
fi

# Check 6: File size check
show_progress "Checking file sizes..."
LARGE_FILES=$(git diff --cached --name-only -z | xargs -0 ls -la 2>/dev/null | awk '$5 > 1048576 {print $9}' || true)
if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}âš ï¸ Large files detected (>1MB):${NC}"
    echo "$LARGE_FILES"
    echo "Consider using Git LFS for large files"
fi

# Check 7: Commit message format (if available)
if [ -f ".gitmessage" ]; then
    show_progress "Validating commit message format..."
    # This would be checked in commit-msg hook
fi

# Coverage check (optional)
if [ -f "package.json" ] && grep -q '"coverage"' package.json; then
    echo ""
    echo "ðŸ“Š Checking test coverage..."
    COVERAGE=$(npm run coverage --silent | grep -oE "All files[^|]*\|[^|]*\|[^|]*\|[^|]*\|[^|]*" | awk '{print $NF}' | sed 's/%//')

    if [ -n "$COVERAGE" ]; then
        if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo -e "${YELLOW}âš ï¸ Test coverage is ${COVERAGE}% (below 80% threshold)${NC}"
            echo "Consider adding more tests"
        else
            echo -e "${GREEN}âœ“ Test coverage: ${COVERAGE}%${NC}"
        fi
    fi
fi

# Final summary
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
echo ""

# Optional: Create snapshot before commit
if [ -d ".toduba/snapshots" ]; then
    SNAPSHOT_ID="pre-commit-$(date +%Y%m%d-%H%M%S)"
    echo "ðŸ“¸ Creating pre-commit snapshot: $SNAPSHOT_ID"
    mkdir -p ".toduba/snapshots/$SNAPSHOT_ID"
    git diff --cached > ".toduba/snapshots/$SNAPSHOT_ID/staged.diff"
    echo "Snapshot saved for potential rollback"
fi

exit 0